"use strict";function in_array(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1}function arrayIntersection(a,b){for(var c=0,d=0,e=new Array;c<a.length&&d<b.length;)a[c]<b[d]?c++:a[c]>b[d]?d++:(e.push(a[c]),c++,d++);return e}function JSONLength(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}Array.prototype.remove=function(a){var b=this.indexOf(a);b>-1&&this.splice(b,1)},define(["angular","app","qrcode","qrcodeUTF8","directives/ngthumb","services/checkcookie"],function(a,b){b.controller("shopCtrl",["$scope","$rootScope","$http",function(a,b,c){b.proxyUrl;a.curSubnav="info",a.modSubnav=function(b){a.curSubnav=b.target.attributes.data.value},a.shopInfo=!0,a.shopPic=!1,a.shopIntro=!1,a.info=function(){a.shopInfo=!0,a.shopPic=!1,a.shopIntro=!1},a.pic=function(){a.shopInfo=!1,a.shopPic=!0,a.shopIntro=!1},a.intro=function(){a.shopInfo=!1,a.shopPic=!1,a.shopIntro=!0}}]),b.controller("shopInfoCtrl",["$scope","$rootScope","$http","$timeout","hascookie",function(a,b,c,d,e){document.title="店铺 -喵喵熊";var f=b.proxyUrl,g=b.globals.shop_id;c.get(f+"/shop/"+g).success(function(b){a.brand_name=b.brand_name,a.shop_name=b.shop_name,a.business_hours=b.business_hours,a.telephone_no=b.telephone_no,a.city_id=b.city_id,a.district_id=b.district_id,a.business_area=b.business_area,a.address=b.address,a.mapmark="经度 "+b.longitude+"  纬度 "+b.latitude,a.shopqrcode=b.qrcode,a.category_list=b.category_name_list[0];a.longitude=b.longitude,a.latitude=b.latitude;c.get(f+"/basic/goodscategories?type=all_tree").success(function(b){a.cate=b.goodscategories,a.ccateChange=function(b){a.category_list=b.name,a.cateid=b.id}});b.city_id,b.district_id;c.get(f+"/basic/city/"+b.city_id).success(function(b){a.city=b,a.curcity_id=a.city.city_id,c.get(f+"/basic/cities").success(function(b){a.citylist=b.cities,c.get(f+"/basic/districts?city_id="+a.curcity_id).success(function(b){a.districtlist=b.districts})})}),c.get(f+"/basic/district/"+b.district_id).success(function(b){a.district=b,a.curdistrict_id=a.district.district_id}),a.myMarkers=[];var d=null;a.mapOptions={ngCenter:{lat:31.871456,lng:117.2935},ngZoom:13,toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,locatecity:!1,resizeEnable:!0},a.$watch("maparea",function(b){if(b){var c=new BMap.Point(a.longitude,a.latitude);b.centerAndZoom(c,18),b.enableDragging(),b.addControl(new BMap.NavigationControl),b.addControl(new BMap.ScaleControl),b.addControl(new BMap.MapTypeControl),b.setDefaultCursor("crosshair"),b.enableContinuousZoom(),b.enableScrollWheelZoom();var d=a.premarker=new BMap.Marker(c);b.addOverlay(d)}}),a.changemapcenter=function(){c.get(f+"/basic/districts?city_id="+a.curcity_id).success(function(b){a.districtlist=b.districts}),a.$watch("maparea",function(b){b&&c.get(f+"/basic/city/"+a.curcity_id).success(function(c){a.cityname=c.city_name,b.centerAndZoom(a.cityname,13),b.enableDragging(),b.addControl(new BMap.NavigationControl),b.addControl(new BMap.ScaleControl),b.setDefaultCursor("crosshair"),b.enableContinuousZoom(),b.enableScrollWheelZoom()})})},a.enter=function(b){a.$watch("maparea",function(c){if(c&&13===b.keyCode){var d=new BMap.LocalSearch(c,{renderOptions:{map:c,autoViewport:!0}});c.clearOverlays(),d.search(a.position);d.setSearchCompleteCallback(function(a){if(d.getStatus()===BMAP_STATUS_SUCCESS)for(var b=0;b<a.getCurrentNumPois();b++){a.getPoi(b)}})}})},a.$watch("maparea",function(b){b&&(a.mapsearch=function(){var c=new BMap.LocalSearch(b,{renderOptions:{map:b,autoViewport:!0}});b.clearOverlays(),c.search(a.position);c.setSearchCompleteCallback(function(a){if(c.getStatus()===BMAP_STATUS_SUCCESS)for(var b=0;b<a.getCurrentNumPois();b++){a.getPoi(b)}})})}),a.addMarker=function(b,c){a.maparea.removeOverlay(a.premarker),d&&a.maparea.removeOverlay(d);var e=new BMap.Marker(c[0].point);a.myMarkers.push(e),a.maparea.addOverlay(e),a.latitude=a.currentMarkerLat=e.getPosition().lat,a.longitude=a.currentMarkerLng=e.getPosition().lng,d=e,a.mapmark="经度"+a.longitude+"   纬度"+a.latitude},a.setZoomMessage=function(b){a.zoomMessage="You just zoomed to "+b+"!"},a.openMarkerInfo=function(b,c){b.preventDefault(),b.stopPropagation(),a.currentMarker=c,a.currentMarkerLat=c.getPosition().lat,a.currentMarkerLng=c.getPosition().lng,a.maparea.addOverlay(a.myInfoWindow),a.maparea.openInfoWindow(a.myInfoWindow,c.getPosition())},a.setMarkerPosition=function(a,b,c){a.setPosition(new BMap.Point(c,b))}}),a.savechange=function(b){if(e.check("mt")){var h={brand_name:a.brand_name,category_list:a.cateid,shop_name:a.shop_name,business_hours:a.business_hours,telephone_no:a.telephone_no,city_id:a.curcity_id,district_id:a.curdistrict_id,business_area:a.business_area,address:a.address,longitude:a.longitude,latitude:a.latitude};c.put(f+"/shop/"+g,h).success(function(c){a.resultinfoyes=b,a.resultinfo=c.is_success?"成功":"失败，未知错误",d(function(){a.resultinfoyes=0},3e3)})}}}]),b.controller("shopIntroCtrl",["$scope","$rootScope","$http","$sce","hascookie",function(a,b,c,d,e){var f=b.globals.shop_id,g=b.proxyUrl,h=b.hostname,i=b._chatProxyUrl;a.editor=!1,a.introduction=null,document.domain=h,a.editorOptions={height:"470px",toolbarCanCollapse:"true",filebrowserImageUploadUrl:"http://"+i+"/ck/file/uploader",filebrowserUploadUrl:"",filebrowserBrowseUrl:""},a.getIntro=function(){var b=g+"/shop/"+f+"/introduction";c.get(b).success(function(b){if(b){for(var c,e=720,f=b.introduction,g=new RegExp("height:(.*?)px; width:(.*?)px",["g"]);c=g.exec(f);)if(c[2]>e){var h=e,i=c[1]*e/c[2];f=f.replace(c[0],"height:"+String(i)+"px; width:"+String(h)+"px")}a.intro=d.trustAsHtml(f)}}).error(function(){})},a.getIntro(),a.editIntro=function(){e.check("mt")&&(a.editor=!0,a.introduction=a.intro)},a.caceledit=function(){a.editor=!1},a.saveIntro=function(){if(e.check("mt")){var b=g+"/shop/"+f+"/introduction",d=a.introduction;c({url:b,method:"POST",data:{introduction:d}}).success(function(b){a.editor=!1,a.getIntro()}).error(function(){a.editor=!1})}}}]),b.controller("shopPicCtrl",["$scope","$rootScope","$http","$state","$stateParams","FileUploader","hascookie",function(a,b,c,d,e,f,g){var h=b.globals.shop_id,i=b.proxyUrl,j=b._chatProxyUrl,k=i+"/shop/"+h+"/image";c.get(k).success(function(b){a.imgInfo=b}).error(function(a){});var l=a.uploader=new f({url:"http://"+j+"/file/uploader",autoUpload:!0});l.filters.push({name:"imageFilter",fn:function(a,b){var c="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(c)}}),l._onProgressItem=function(b,c){g.check("mt")&&(a.inupload=!0)},l._onSuccessItem=function(b,d,e,f){if(g.check("mt")&&d.url){l.queue.splice(0,1),a.imgInfo.shop_img_urls.unshift(d.url);var h=a.imgInfo.shop_img_urls.toString(),i={pic_url_list:h};c({url:k,method:"PUT",data:i}).success(function(a){a.is_success}).error(function(){})}},a.zoom=function(b,c){if(g.check("mt")){a.showimg=!0,a.imagesource=b+"@752w_752h_0e_1l";var d=JSONLength(a.imgInfo.shop_img_urls);a.noLast=!1,a.noNext=!1,0==c&&(a.noLast=!0),c==d-1&&(a.noNext=!0),a.backwardPic=function(b){var d=--c;d>=0?a.imagesource=a.imgInfo.shop_img_urls[d]+"@752w_752h_0e_1l":(a.imagesource=a.imgInfo.shop_img_urls[0]+"@752w_752h_0e_1l",c=0),0==c&&(a.noLast=!0),a.noNext=!1},a.forwardPic=function(b){var e=++c;d>e?a.imagesource=a.imgInfo.shop_img_urls[e]+"@752w_752h_0e_1l":(a.imagesource=a.imgInfo.shop_img_urls[d-1]+"@752w_752h_0e_1l",c=d-1),c==d-1&&(a.noNext=!0),a.noLast=!1}}},a.delPic=function(b){if(g.check("mt")){a.imgInfo.shop_img_urls.remove(b);var d=a.imgInfo.shop_img_urls.toString(),e={pic_url_list:d};c.put(k,e).success(function(){})}}}])});