Array.prototype.remove=function(a){var b=this.indexOf(a);b>-1&&this.splice(b,1)},define(["angular","app","services/ucmsgdata","services/checkcookie"],function(a,b){b.controller("messageCtrl",["$scope","$rootScope","$http","$window","$timeout","$q","ucmsgdata","$sce","hascookie",function(a,b,c,d,e,f,g,h,i){function j(){if(m.length>0){a.msgshow=!0,a.nomsg=!1;for(var b=0;b<m.length;b++)if("SEND_FANS_M"===m[b].c){n.push(b),c.get(k+"/shop/"+m[b].shop).success(function(a){var b={name:a.shop_name,pic:a.pic_url_list[0]},c=n.splice(0,1);for(var d in b)m[c][d]=b[d]}),m[b].body1=m[b].body.replace(/<img([\d\D]*?)\/>/gi,"[ 图片 ]"),"<br>[ 图片 ]"==m[b].body1&&(m[b].body1="[ 图片 ]");for(var d,e=720,f=m[b].body,g=new RegExp("width:(.*?)px; height:(.*?)px",["g"]);d=g.exec(f);)if(d[1]>e){var i=e,j=d[2]*e/d[1];f=f.replace(d[0],"height:"+String(j)+"px; width:"+String(i)+"px")}m[b].body2=h.trustAsHtml(f)}}}document.title="通知消息 -喵喵熊";var k=b.proxyUrl,l=(b.globals.userID,a.user={});a.nomsg=!0;var m=a.data=g.data,n=[];j(),a.$on("reloadMsg",function(b,c){i.check("cm")&&(j(),a.shopmsgshow=!1)}),a.msglist=m,a.aggree=function(b,d){i.check("cm")&&(c.post(k+"/user/friend/accept?uid="+b+"&accept=1").success(function(a){}),a.msglist[d].add1=!0,a.msglist[d].add2=!0,a.msglist[d].buttons=!0)},a.refuse=function(b,d){i.check("cm")&&(c.post(k+"/user/friend/accept?uid="+b+"&accept=0").success(function(a){}),a.msglist[d].add1=!0,a.msglist[d].add3=!0,a.msglist[d].buttons=!0)},l.openshopmsg=function(a,b,c,d,f){i.check("cm")&&(l.scrollTop=$(window).scrollTop(),o(),e(function(){p(a,b,c,d,f)},300))};var o=function(){var c=["../views/customer/account/message/shopmsg/shopmsgCtrl"],d=f.defer();require(c,function(){b.$apply(function(){d.resolve()})}),d.promise.then(function(b){a.msgshow=!1,a.shopmsgshow=!0})},p=function(b,c,d,e,f){var g={shopid:d,shopname:c,index:f,scrollTop:l.scrollTop,time:e,html:b};a.$broadcast("openshopmsg",g)};a.$on("closeshopmsg",function(b,c){a.msgshow=!0,a.shopmsgshow=!1,e(function(){d.scrollTo(0,c.scrollTop)},100)})}])});