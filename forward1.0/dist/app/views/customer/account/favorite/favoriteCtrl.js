"use strict";Array.prototype.S=String.fromCharCode(2),Array.prototype.in_array=function(a){var b=new RegExp(this.S+a+this.S);return b.test(this.S+this.join(this.S)+this.S)},define(["angular","app","qrcode","qrcodeUTF8","services/checkcookie"],function(a,b){b.controller("CollectCtrl",["$scope","$rootScope","$http","$window","$q","$timeout","$interval","hascookie",function(a,b,c,d,e,f,g,h){var j=b.proxyUrl,k=b.globals.userID,l=j+"/userweb/"+k+"/favorites",m=a.user={};m.allcolData=[];var n="收藏 -喵喵熊";document.title=n,a.hascollect=!0;var o=function(b,d){c({url:l,method:"GET",params:{limit:d,offset:b}}).success(function(b){for(var c=b.goods,d=0;d<c.length;d++)c[d].idontknow=c[d].promot<1?c[d].price:c[d].promot;b.goods.length>0&&m.maxNum++,m.allcolData=m.allcolData.concat(b.goods),a.goodslist=b.goods=m.allcolData,a.goodslist.length>0?(a.nocollect=!1,a.collect=!0):(a.nocollect=!0,a.collect=!1)})};a.toggle1=function(b,d){h.check("cm")&&(a.goodslist[b].ifshow=a.goodslist[b].ifshow?!1:!0,c["delete"](j+"/user/goods/concern?gid="+d).success(function(a){}))},a.toggle2=function(b,d){h.check("cm")&&(a.goodslist[b].ifshow=a.goodslist[b].ifshow?!1:!0,c.post(j+"/user/goods/concern?gid="+d).success(function(a){}))};var p,n="收藏 -喵喵熊",q=j+"/userweb/activity",r=!0;m.showAct=!1;var s=function(b){if(h.check("cm"))if("list"==b.type)a.$broadcast("intoAct",{cid:m.curCity.id});else if("del"===b.type){var d=m.actList[b.idx];a.$broadcast("intoAct",{activity:d})}else if("chatToDel"===b.type){var e=q+"/"+b.id;c({url:e,method:"GET"}).success(function(b){b.shopPic=b.shopPic[0],a.$broadcast("intoAct",{activity:b,fromChat:!0})}).error()}};m.intoAct=function(){m.scrollTop=$(window).scrollTop();var c=["../views/customer/account/activity/activityCtrl"],d=e.defer();require(c,function(){b.$apply(function(){d.resolve()})}),d.promise.then(function(b){a.hascollect=!1,a.shopdel=!1,m.showAct=!0})},m.showActDet=function(a){r&&(r=!1,m.intoAct(),p=g(function(){s({type:"del",idx:a})},300))},m.chatToAct=function(a){r&&(r=!1,m.intoAct(),p=g(function(){s({type:"chatToDel",id:a.id})},300))},m.sendAct=function(b,c,d){var e={type:"act",id:b,name:c,img:d};a.$emit("_sendObjChannel",e)},a.$on("recvAct",function(a,b){g.cancel(p),r=!0}),a.$on("closeActList",function(b,c){document.title=n,a.hascollect=!0,m.showAct=!1,a.shopdel=!1}),a.$on("closeActDet1",function(b,c){document.title=n,a.hascollect=!0,m.showAct=!1,a.shopdel=!1}),a.$on("actToShop",function(a,b){m.showAct=!1,m._intoShop(b)});var t,u=!0;m.intoShop=function(a,b){if(h.check("cm")){m.scrollTop=$(window).scrollTop();var c={gid:a,idx:b};m._intoShop(c)}},m._intoShop=function(a){u&&(u=!1,a.sid&&v(a.sid),w(),t=g(function(){x(a)},300))};var v=function(a){if(h.check("cm")){var b=j+"/user/shop/enter?sid="+a;c({url:b,method:"POST"}).success(function(a){}).error()}},w=function(){var c=["../views/customer/account/shopDel/shopDelCtrl"],d=e.defer();require(c,function(){b.$apply(function(){d.resolve()})}),d.promise.then(function(b){a.hascollect=!1,m.showAct=!1,a.shopdel=!0})},x=function(b){var c=b;c.scrollTop=m.scrollTop,a.$broadcast("intoShop",c)},y=j+"/user/goods/info",z=j+"/user/shop/name";a.$on("_recvObjChannel",function(b,d){if("shop"===d.type){var e={shopIDs:[]};c.post(j+"/user/fans/diff",e).success(function(b){m.fansid=b.addShopIDs;a.isFans=m.fansid.in_array(d.id)});var f={sid:d.id,sname:d.name,isFans:!a.isFans,fromChat:!0};m._intoShop(f)}else if("goods"===d.type){var g={gid:d.id};c({url:l,method:"GET",params:{limit:0,offset:0}}).success(function(b){for(m.favids=[],i=0;i<b.goods.length;i++)favids[i]=b.goods[i].id;a.isfaved=m.favids.in_array(d.id)}),c({url:y,method:"GET",params:{gid:d.id,fromChat:!0}}).success(function(b){0==b.err&&(g.sid=b.info.shop_id,c({url:z,method:"GET",params:{sid:b.info.shop_id}}).success(function(b){0==b.err&&(g.sname=b.shopName,g.isFans=!a.isfaved,m._intoShop(g))}).error())}).error()}else if("act"===d.type){var h={id:d.id};m.chatToAct(h)}}),a.$on("recv",function(a,b){g.cancel(t),u=!0}),a.$on("closeShop",function(b,c){document.title=n,void 0!=c.idx&&(a.goodslist[c.idx].ifshow=!c.isFans),a.hascollect=!0,a.shopdel=!1,m.showAct=!1,f(function(){d.scrollTo(0,c.scrollTop)},100)}),a.$on("closeGoods",function(b,c){document.title=n,a.hascollect=!0,a.shopdel=!1,m.showAct=!1;var e;for(i=0;i<a.goodslist.length;i++)a.goodslist[i].id==c.id&&(e=i);void 0!=e&&(a.goodslist[e].ifshow=!c.isFav),f(function(){d.scrollTo(0,m.scrollTop)},100)}),a.$on("recv1",function(a,b){}),o(0,14);var A=0,B=1;m.maxNum=B;var C=0;a.$on("scroll",function(a,b){{var c=($(window).scrollTop(),b.docHeight);$(window).height()}if(C=b.totalHeight,C>=c-A&&0!=m.allcolData.length&&B!=m.maxNum){var d=14*B;o(d,14),B++}})}])});