"use strict";define(["angular","app","directives/doimg","directives/lazyload","directives/repeatemit","services/checkcookie"],function(a,b){b.controller("shopsCtrl",["$scope","$rootScope","$http","$window","$timeout","$interval","$q","$stateParams","$location","hascookie",function(a,b,c,d,e,f,g,h,i,j){var k=10,l=0,m=5,n=5,o=50,p="喵喵熊 -边逛边聊";document.title=p;{var q=a.user={},r=b.proxyUrl,s=r+"/user/city",t=r+"/user/shop",u=r+"/user/shop/search",v=r+"/user/fans/diff",w=r+"/user/goods/info",x=r+"/user/shop/name",y=r+"/user/activity",z=r+"/userweb/activity",A=h.city||null,B=h.w||null;h.page||null}q.curCity={name:"合肥",id:1048577},q.cateList=[],q.shopList=[],q.allshopsData=[],function(){c({url:s,method:"GET"}).success(function(b){if(0==b.err){if(q.cityList=b.cityList,A)for(var d=0,e=q.cityList.length;e>d;d++)if(A==q.cityList[d].id){q.curCity=q.cityList[d],a.$emit("changeHome",q.curCity.id);break}B?(q.searchInput=B,console.log("searchhhhhhhhhhhh"),c({url:u,method:"GET",params:{name:B,city:q.curCity.id,offset:0,count:k}}).success(H).error()):G(0,q.curCity.id,0,k),C()}}).error()}();var C=function(){c({url:y,method:"GET",params:{city:q.curCity.id,offset:0,count:3}}).success(function(a){if(0==a.err)if(0==a.actList.length)q.noAct=!0;else{q.noAct=!1;for(var b=0,c=a.actList.length;c>b;b++)a.actList[b].bt=a.actList[b].bt.split(" ")[0],a.actList[b].et=a.actList[b].et.split(" ")[0];q.actList=a.actList}}).error()};q.mCity=!1,q.mCity=function(){q.cityHover=!q.cityHover},q.selectCity=function(a){q.curCity=a,A=a.id,i.path("/customer/account/shops").search({city:a.id})},q.search=function(){return console.log("search"),q.searchInput?(i.path("/customer/account/shops").search(A?{city:A,w:q.searchInput}:{w:q.searchInput}),void console.log("ssssssssss,"+q.searchInput)):void(A?i.path("/customer/account/shops").search({city:A}):i.path("/customer/account"))};var D=6048e5,E=function(){return Date.parse(new Date)},F=function(a){var b=a.replace(/-/g,"/");return Date.parse(new Date(b))};q.curPage=1,q.maxSize=n,q.itemsPerPage=o,q.totalCount=0,a.selectPage=function(a){if(j.check("cm")){q.continueLoading=!1,q.showPagi=!1,console.log("page,"+a);var b=(a-1)*q.itemsPerPage;q.shopList=[],q.allshopsData=[],q._allshopsData=[],M=1,q.loadComplete=!0,G(0,q.curCity.id,b,k)}},q.noShops=!1;var G=function(a,b,d,e){"undefined"==typeof h.w?c({url:t,method:"GET",params:{category:a,city:b,offset:d,count:e}}).success(H).error(function(a){q.continueLoading=!1}):c({url:u,method:"GET",params:{name:B,city:q.curCity.id,offset:d,count:k}}).success(H).error()},H=function(a){q.shopTotal=a.total_num,q.totalPages=parseInt((q.shopTotal+q.itemsPerPage-1)/q.itemsPerPage),0==a.shopList.length&&0==q.allshopsData.length?(q.noShops=!0,q.showPagi=!1):(q.noShops=!1,q.showPagi=!0),q.shopList=a.shopList,0==a.err&&0!=a.shopList.length?(a.total_num==a.shopList.length&&(q.continueLoading=!1),q.totalCount+=a.shopList.length,c({url:v,method:"POST",data:{shopIDs:[]}}).success(I).error()):q.continueLoading=!1},I=function(a){if(0==a.err){q.favShops=a.addShopIDs;for(var b=[],d=0,e=q.shopList.length;e>d;d++)b[d]=q.shopList[d].id;var f=r+"/userweb/shopgoods/"+b.toString();c({url:f,method:"GET"}).success(J).error()}},J=function(a){q._allshopsData=[];for(var b=0,c=q.shopList.length;c>b;b++){a.shops[b].fansNum=q.shopList[b].fans,a.shops[b].customersNum=q.shopList[b].customers;for(var d=0,e=a.shops[b].goods.length;e>d;d++)a.shops[b].goods[d].newGoods=E()-F(a.shops[b].goods[d].time)<D?!0:!1;for(var f=0,g=q.favShops.length;g>f;f++){if(a.shops[b].shop_id==q.favShops[f]){a.shops[b].isFans=!0;break}a.shops[b].isFans=!1}}q.allshopsData=q.allshopsData.concat(a.shops),q._allshopsData=a.shops,console.log("curPageeeeeeee",q.curPage+"-"+q.totalPages)},K=!0;q.showAct=!1;var L=function(b){if("list"==b.type)a.$broadcast("intoAct",{cid:q.curCity.id});else if("del"===b.type){console.log("shopsssssssssssssss,"+b),console.log(q.actList),console.log(q.actList[b.idx].content);var d=q.actList[b.idx];a.$broadcast("intoAct",{activity:d})}else if("chatToDel"===b.type){var e=z+"/"+b.id;c({url:e,method:"GET"}).success(function(b){b.shopPic=b.shopPic[0],a.$broadcast("intoAct",{activity:b,fromChat:!0})}).error()}};q.showActList=function(){j.check("cm")&&(q.intoAct(),N=f(function(){L({type:"list"})},300))},q.intoAct=function(){if(j.check("cm")){q.scrollTop=$(window).scrollTop();var a=["../views/customer/account/activity/activityCtrl"],c=g.defer();require(a,function(){b.$apply(function(){c.resolve()})}),c.promise.then(function(a){q.shopsShow=!1,q.showShop=!1,q.showAct=!0})}},q.showActDet=function(a){j.check("cm")&&K&&(K=!1,q.intoAct(),N=f(function(){L({type:"del",idx:a})},300))},q.chatToAct=function(a){j.check("cm")&&K&&(K=!1,q.intoAct(),N=f(function(){L({type:"chatToDel",id:a.id})},300))},q.sendAct=function(b,c,d){if(j.check("cm")){var e={type:"act",id:b,name:c,img:d};a.$emit("_sendObjChannel",e)}},a.$on("recvAct",function(a,b){f.cancel(N),K=!0}),a.$on("closeActList",function(a,b){document.title=p,q.shopsShow=!0,q.showAct=!1}),a.$on("closeActDet1",function(a,b){document.title=p,q.shopsShow=!0,q.showAct=!1}),a.attentionFlag=!0,q.interest=function(b,d,e){if(j.check("cm")){var f=r+"/user/shop/concern?sid="+b;if(!a.attentionFlag)return;d?(a.attentionFlag=!1,c({url:f,method:"DELETE"}).success(function(b){0==b.err&&(q.allshopsData[e].isFans=!1,--q.allshopsData[e].fansNum),a.attentionFlag=!0}).error(function(b){a.attentionFlag=!0})):c({url:f,method:"POST"}).success(function(b){0==b.err&&(q.allshopsData[e].isFans=!0,++q.allshopsData[e].fansNum),a.attentionFlag=!0}).error(function(b){a.attentionFlag=!0})}};var M=1;q.continueLoading=!0,q.showPagi=!1,q.shopsShow=!0,q.showShop=!1;var N,O=!0;q.intoShop=function(a,b,c,d){if(j.check("cm")){q.scrollTop=$(window).scrollTop();var e={sid:a,sname:b,isFans:c,idx:d};q._intoShop(e)}},q._intoShop=function(a){j.check("cm")&&O&&(console.log("intoshopppppppppppp"),O=!1,P(a.sid),Q(),N=f(function(){R(a)},300))};var P=function(a){var b=r+"/user/shop/enter?sid="+a;c({url:b,method:"POST"}).success(function(a){}).error()},Q=function(){var a=["../views/customer/account/shopDel/shopDelCtrl"],c=g.defer();require(a,function(){b.$apply(function(){c.resolve()})}),c.promise.then(function(a){q.shopsShow=!1,q.showAct=!1,q.showShop=!0})},R=function(b){var c=b;c.scrollTop=q.scrollTop,a.$broadcast("intoShop",c)};q.showGoods=function(a,b,c,d,e){if(j.check("cm")){var f={gid:a,sid:b,sname:c,isFans:d,idx:e};q.scrollTop=$(window).scrollTop(),f.scrollTop=q.scrollTop,q._intoShop(f)}},q.sendShop=function(b,d){if(j.check("cm")){var e={type:"shop"},f=r+"/shop/"+b,g="";c({url:f,method:"GET"}).success(function(c){0!=c.pic_url_list.length&&(g=c.pic_url_list[0]),e.img=g,e.id=b,e.name=d,a.$emit("_sendObjChannel",e)}).error()}},q.sendGoods=function(b,c,d,e){if(j.check("cm")){var f={type:"goods",id:c,name:d,img:e,sid:b};a.$emit("_sendObjChannel",f)}},q.intoChat=function(b){j.check("cm")&&a.$emit("_enterShopChannel",b)},a.$on("goodsToShop",function(a,b){var c={sid:b.id,sname:b.name};q._intoShop(c)}),a.$on("_recvObjChannel",function(a,b){if(console.log("recvObjChannelllllllllllllllll"),console.log(b),"shop"===b.type){var d={sid:b.id,sname:b.name,fromChat:!0};q._intoShop(d)}else if("goods"===b.type){var e={gid:b.id};c({url:w,method:"GET",params:{gid:b.id}}).success(function(a){0==a.err&&(e.sid=a.info.shop_id,c({url:x,method:"GET",params:{sid:a.info.shop_id}}).success(function(a){0==a.err&&(e.sname=a.shopName,q._intoShop(e))}).error())}).error()}else if("act"===b.type){var f={id:b.id};q.chatToAct(f)}}),a.$on("actToShop",function(a,b){q.showAct=!1,q._intoShop(b)}),q.loadComplete=!0,a.$on("lastemit",function(a,b){q.loadComplete=!0}),a.$on("scroll",function(a,b){if(q.shopsShow)if(q.loadComplete&&b.docHeight-l<=b.totalHeight&&0!=q.shopList.length&&0!=q._allshopsData.length&&M!=m){q.loadComplete=!1,console.log("nummmmmmm,"+M),q.continueLoading=!0;var c=M*k+(q.curPage-1)*q.itemsPerPage;G(0,q.curCity.id,c,k),M++}else(M==m||q.totalCount==q.shopTotal)&&(q.totalPages>=1,q.continueLoading=!1)}),a.$on("closeShop",function(a,b){if(document.title=p,q.shopsShow=!0,q.showShop=!1,void 0!=b.idx)q.allshopsData[b.idx].fansNum=b.fansNum,q.allshopsData[b.idx].isFans=b.isFans,q.allshopsData[b.idx].customersNum=b.cmCount,console.log("scrolllllllllllllltop,"+b.scrollTop),e(function(){d.scrollTo(0,q.scrollTop)},100);else{for(var c=0,f=q.allshopsData.length;f>c;c++)if(b.shop_id==q.allshopsData[c].shop_id){q.allshopsData[c].fansNum=b.fansNum,q.allshopsData[c].isFans=b.isFans,q.allshopsData[c].customersNum=b.cmCount;break}e(function(){d.scrollTo(0,q.scrollTop)},100)}}),a.$on("closeGoods",function(a,b){document.title=p,q.shopsShow=!0,q.showShop=!1,e(function(){d.scrollTo(0,q.scrollTop)},100)}),a.$on("recv",function(a,b){f.cancel(N),O=!0})}])});