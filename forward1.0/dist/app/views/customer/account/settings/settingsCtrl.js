"use strict";define(["angular","app","md5","services/authorization","qrcode","services/checkcookie"],function(a,b){b.controller("settings",["$scope","$rootScope","authorization","$http","$modal","FileUploader","$timeout","$interval","hascookie",function(a,b,c,d,e,f,g,h,i){document.title="用户设置 -喵喵熊";var j=b.proxyUrl,k=a.getInfo=function(){d({url:j+"/user/personal",method:"GET"}).success(function(b){console.log(b),0==b.err&&(a.personal=b.info,null==a.personal.gender&&(a.personal.gender=0),a.personal.city?d({url:j+"/basic/city/"+a.personal.city,method:"GET"}).success(function(b){a.personal.province=b.province_id,n(a.personal.province)}):a.personal.province=0,a.$watch("personal.city",function(){l(4)}))})};k();var l=(a.changeName=function(b){i.check("cm")&&a.$emit("changeName",b)},a.saveInfo=function(b){i.check("cm")&&d({url:j+"/user/personal",method:"POST",data:{attr:b,name:a.personal.name,portrait:a.personal.portrait,gender:a.personal.gender,city:a.personal.city}}).success(function(a){console.log(a)})}),m=a.getProvinces=function(){d({url:j+"/basic/provinces?all=1",methos:"GET"}).success(function(b){a.this_province=b.provinces})};m();{var n=a.getCitys=function(b){return d({url:j+"/basic/cities?all=1&province_id="+String(b),method:"GET"}).success(function(b){a.this_city=b.cities}),!1};a.getCitysAndSet=function(b){return d({url:j+"/basic/cities?all=1&province_id="+String(b),method:"GET"}).success(function(b){a.this_city=b.cities,a.personal.city=a.this_city[0].city_id}),!1}}a.this_gender=[{label:"男",id:1},{label:"女",id:2},{label:"秘密",id:0}];var o=a.getAddress=function(){d({url:j+"/user/address",method:"GET"}).success(function(b){a.addressList=b.addressList.sort(function(a,b){return a["default"]<b["default"]}),console.log(a.addressList)})};o();var p=a.setDefaultAddress=function(a){i.check("cm")&&d({url:j+"/user/address/default",method:"POST",data:{addrID:a}}).success(function(a){o()})},q=(a.deleteAddress=function(b,c){i.check("cm")&&d({url:j+"/user/address",method:"DELETE",data:{addrID:b}}).success(function(b){d({url:j+"/user/address",method:"GET"}).success(function(b){a.addressList=b.addressList.sort(function(a,b){return a["default"]<b["default"]}),a.addressList.length>0&&1==c&&p(a.addressList[0].addrID)})})},a.uploader=new f({url:"http://"+b._chatProxyUrl+"/file/uploader",autoUpload:!0}));q.filters.push({name:"imageFilter",fn:function(a,b){var c="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(c)}}),q.onAfterAddingFile=function(b){console.info("onAfterAddingFile",b),a.is_show=!1,a.inupload=!0},q._onSuccessItem=function(b,c,d,e){console.log("successupload,"+c.url),c.url&&(a.personal.portrait=c.url,a.$emit("changeHead",c.url),a.small_portrait_url=c.url+"@100w_100h.jpg",l(2))},q.onCompleteAll=function(){a.inupload=!1};a.popphone=function(){var b=e.open({animation:!0,templateUrl:"views/customer/account/settings/popphone.html",controller:["$scope","$modalInstance","$http","phone",function(a,b,c,d){a.sended=!1,a.phone=d,a.captcha_url=j+"/basic/captcha",a.refreshCaptcha=function(){a.captcha_url=j+"/basic/captcha?rnd="+String(Math.random())},a._cancel=function(){b.close()},a._confirm=function(){a.submitted=!0,c({url:j+"/user/bindphone",method:"POST",data:{phone:a.newPhone}}).success(function(c){0===c.err&&b.close(a.newPhone)})},a.validsuccess=!0,a.validcaptcha=function(){c({url:j+"/basic/captcha",method:"POST",data:{captcha_str:a.captcha}}).success(function(b){return b.is_success?(a.validsuccess=!0,!0):(a.validsuccess=!1,!1)})},a.phoneValidsuccess=!0,a.sendPhoneValid=function(){i.check("cm")&&c({url:j+"/basic/phonevalidate/"+a.phone,method:"GET"}).success(function(b){a.sended=!0,a.time=60,h(function(){a.time>1?a.time=a.time-1:(a.sended=!1,a.time=60)},1e3,60),console.log(b)})},a.validPhoneCaptcha=function(){i.check("cm")&&c({url:j+"/basic/phonevalidate/"+a.phone,method:"POST",data:{code:a.phoneCaptcha}}).success(function(b){a.phoneValidsuccess=b.is_success?!0:!1})},a.submitted=!1,a.submitForm=function(){a.submitted=!0,c({url:j+"user/bindphone",method:"POST",data:{phone:a.newPhone}}).success(function(a){0===a.err&&b.close()})}}],resolve:{host:function(){return a.host},phone:function(){return a.personal.phone}},size:"lg",windowClass:"mag-pop-modal",backdropClass:"modal-backdrop"});b.result.then(function(b){b&&(a.personal.phone=b)})},a.popnewphone=function(){var b=e.open({animation:!0,templateUrl:"views/customer/account/settings/newphone.html",controller:["$scope","$modalInstance","$http",function(a,b,c){a.captcha_url=j+"/basic/captcha",a.refreshCaptcha=function(){a.captcha_url=j+"/basic/captcha?rnd="+String(Math.random())},a._confirm=function(){a.submitted=!0,c({url:j+"/user/bindphone",method:"POST",data:{phone:a.newPhone}}).success(function(c){0===c.err&&b.close(a.newPhone)})},a._cancel=function(){b.close()},a.validsuccess=!1,a.validcaptcha=function(){(a.captcha.length>=4||a.validsuccess)&&i.check("cm")&&c({url:j+"/basic/captcha",method:"POST",data:{captcha_str:a.captcha}}).success(function(b){return b.is_success?(a.validsuccess=!0,!0):(a.validsuccess=!1,!1)})},a.phoneValidsuccess=!1,a.hasphoneValidsuccess=!1,a.sendPhoneValid=function(){c({url:j+"/basic/phonevalidate/"+a.newPhone,method:"GET"}).success(function(b){a.sended=!0,a.time=60,h(function(){a.time>1?a.time=a.time-1:(a.sended=!1,a.time=60)},1e3,60)})},a.validPhoneCaptcha=function(){(a.phoneCaptcha.length>=6||a.hasphoneValidsuccess)&&c({url:j+"/basic/phonevalidate/"+a.newPhone,method:"POST",data:{code:a.phoneCaptcha}}).success(function(b){a.phoneValidsuccess=b.is_success?!0:!1,a.hasphoneValidsuccess=!0})},a.submitted=!1,a.submitForm=function(){a.submitted=!0,c({url:j+"user/bindphone",method:"POST",data:{phone:a.newPhone}}).success(function(a){console.log(a),0===a.err&&b.close()})}}],resolve:{host:function(){return a.host}},size:"lg",windowClass:"mag-pop-modal",backdropClass:"modal-backdrop"});b.result.then(function(b){b&&(a.personal.phone=b)})},a.popnewaddress=function(){var b=e.open({animation:!0,templateUrl:"views/customer/account/settings/address.html",controller:["$scope","$modalInstance","$http",function(a,b,c){a._confirm=function(){a.submitted=!0,c({url:j+"/user/address",method:"PUT",data:{name:a.name,phone:a.phone,address:a.address,postcode:a.code,province_id:a.province,city_id:a.city}}).success(function(a){0===a.err&&b.close()})},a._cancel=function(){b.close()};var d=a.getProvinces=function(){c({url:j+"/basic/provinces",methos:"GET"}).success(function(b){a.this_province=b.provinces,a.province=a.this_province[0].province_id,e(a.province)})};d();var e=a.getCitys=function(b){return c({url:j+"/basic/cities?province_id="+String(b),method:"GET"}).success(function(b){a.this_city=b.cities,a.city=a.this_city[0].city_id}),!1}}],resolve:{host:function(){return a.host}},size:"lg",windowClass:"mag-pop-modal",backdropClass:"modal-backdrop"});b.result.then(function(){o()})},a.popmodifyaddress=function(b){var c=e.open({animation:!0,templateUrl:"views/customer/account/settings/modifyaddress.html",controller:["$scope","$modalInstance","$http",function(a,c,d){a.name=b.name,a.phone=b.phone,a.address=b.address,a.postcode=b.postcode,a.addrID=b.addrID,a.province=b.province_id,a.city=b.city_id,a._confirm=function(){a.submitted=!0,d({url:j+"/user/address",method:"POST",data:{addrID:a.addrID,name:a.name,phone:a.phone,address:a.address,postcode:a.postcode,province_id:a.province,city_id:a.city}}).success(function(a){0===a.err&&c.close()})},a._cancel=function(){c.close()};var e=a.getProvinces=function(){d({url:j+"/basic/provinces",methos:"GET"}).success(function(b){a.this_province=b.provinces,f(a.province)})};e();{var f=a.getCitys=function(b){return d({url:j+"/basic/cities?province_id="+String(b),method:"GET"}).success(function(b){a.this_city=b.cities}),!1};a.getCitysAndSet=function(b){return d({url:j+"/basic/cities?province_id="+String(b),method:"GET"}).success(function(b){a.this_city=b.cities,a.city=a.this_city[0].city_id}),!1}}}],resolve:{host:function(){return a.host}},size:"lg",windowClass:"mag-pop-modal",backdropClass:"modal-backdrop"});c.result.then(function(){o()})}}])});