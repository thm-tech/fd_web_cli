Array.prototype.remove=function(a){var b=this.indexOf(a);b>-1&&this.splice(b,1)},Array.prototype.S=String.fromCharCode(2),Array.prototype.in_array=function(a){var b=new RegExp(this.S+a+this.S);return b.test(this.S+this.join(this.S)+this.S)},define(["angular","app","services/checkcookie"],function(a,b){b.controller("FavCtrl",["$scope","$rootScope","$http","$window","$timeout","$q","$interval","hascookie",function(a,b,c,d,e,f,g,h){document.title="粉店 -喵喵熊";var j=b.proxyUrl,k=b.globals.userID,l=a.user={};l.allfavData=[];var m={shopIDs:[]};l.len=a.user.len;var n=j+"/userweb/"+k+"/favorites",o=j+"/user/fans/diff";l._shopids=[],l.shopsShow=!0;var p=function(b){c.post(j+"/user/fans/diff",m).success(function(d){vshopids=d.addShopIDs,l.favsi=[];for(var e=0;e<vshopids.length;e++)l.favsi[e]="sid="+vshopids[e]+"&";for(var e=0;e<vshopids.length;e++)l.favsi.remove("sid=undefined&");var f=j+"/user/fans/info?"+l.favsi.join(""),g=f.substring(0,f.length-1);c({url:g,method:"GET"}).success(function(d){if(0==d.err){for(var e=0;e<d.shopList.length;e++)l._shopids[e]=d.shopList[e].id;l.favshopidlist=l._shopids,l.len=l.favshopidlist.length;var f=l.listnums=Math.ceil(l.len/16);if(f>=b){l.favss=[];for(var e=16*(b-1);16*b>e;e++)l.favss[e]="sid="+l.favshopidlist[e]+"&";for(var e=0;16>e;e++)l.favss.remove("sid=undefined&");var g=j+"/user/fans/info?"+l.favss.join(""),i=g.substring(0,g.length-1);c({url:i,method:"GET"}).success(function(d){l.allfavData=l.allfavData.concat(d.shopList),a.favlist=l.allfavData,a.favlist.length<1?(a.nocollect=!0,a.hascollect=!1):(a.nocollect=!1,a.hascollect=!0),l.favsss=[];for(var e=0;e<l.len;e++)l.favsss[e]="sid="+l.favshopidlist[e]+"&";for(var e=0;e<l.len;e++)l.favsss.remove("sid=undefined&");var g=j+"/user/fans/news?"+l.favsss.join(""),i=g.substring(0,g.length-1);c({url:i,method:"GET"}).success(function(a){if(l.len<16)for(var c=0;c<l.len;c++)l.allfavData[c].hasNew=1==a.shopList[c].hasNew?!0:!1,l.allfavData[c].hasAct=1==a.shopList[c].hasAct?!0:!1;else if(f>b)for(var c=0;16*b>c;c++)l.allfavData[c].hasNew=1==a.shopList[c].hasNew?!0:!1,l.allfavData[c].hasAct=1==a.shopList[c].hasAct?!0:!1;else if(b==f)for(var c=0;c<l.len;c++)l.allfavData[c].hasNew=1==a.shopList[c].hasNew?!0:!1,l.allfavData[c].hasAct=1==a.shopList[c].hasAct?!0:!1}),a.toggle1=function(b,d){h.check("cm")&&(a.favlist[b].ifshow=a.favlist[b].ifshow?!1:!0,c["delete"](j+"/user/shop/concern?sid="+d).success(function(a){}))},a.toggle2=function(b,d){h.check("cm")&&(a.favlist[b].ifshow=a.favlist[b].ifshow?!1:!0,c.post(j+"/user/shop/concern?sid="+d).success(function(a){}))}})}}else a.nocollect=!0}).error()})},q="粉店 -喵喵熊",r=j+"/userweb/activity",s=!0;l.showAct=!1;var t=function(b){if("list"==b.type)a.$broadcast("intoAct",{cid:l.curCity.id});else if("del"===b.type){var d=l.actList[b.idx];a.$broadcast("intoAct",{activity:d})}else if("chatToDel"===b.type){var e=r+"/"+b.id;c({url:e,method:"GET"}).success(function(b){b.shopPic=b.shopPic[0],a.$broadcast("intoAct",{activity:b,fromChat:!0})}).error()}};l.intoAct=function(){if(h.check("cm")){l.scrollTop=$(window).scrollTop();var a=["../views/customer/account/activity/activityCtrl"],c=f.defer();require(a,function(){b.$apply(function(){c.resolve()})}),c.promise.then(function(a){l.shopsShow=!1,l.showShop=!1,l.showAct=!0})}},l.showActDet=function(a){h.check("cm")&&s&&(s=!1,l.intoAct(),u=g(function(){t({type:"del",idx:a})},300))},l.chatToAct=function(a){h.check("cm")&&s&&(s=!1,l.intoAct(),u=g(function(){t({type:"chatToDel",id:a.id})},300))},l.sendAct=function(b,c,d){if(h.check("cm")){var e={type:"act",id:b,name:c,img:d};a.$emit("_sendObjChannel",e)}},a.$on("recvAct",function(a,b){g.cancel(u),s=!0}),a.$on("closeActList",function(a,b){document.title=q,l.shopsShow=!0,l.showAct=!1}),a.$on("closeActDet1",function(a,b){document.title=q,l.shopsShow=!0,l.showAct=!1}),a.$on("actToShop",function(a,b){l.showAct=!1,l._intoShop(b)});var u,v=!0;l.intoShop=function(a,b,c,d){if(h.check("cm")){l.scrollTop=$(window).scrollTop();var e={sid:a,sname:b,isFans:c,idx:d};l._intoShop(e)}},l._intoShop=function(a){v&&(v=!1,w(a.sid),x(),u=g(function(){y(a)},300))};var w=function(a){var b=j+"/user/shop/enter?sid="+a;c({url:b,method:"POST"}).success(function(a){}).error()},x=function(){var a=["../views/customer/account/shopDel/shopDelCtrl"],c=f.defer();require(a,function(){b.$apply(function(){c.resolve()})}),c.promise.then(function(a){l.shopsShow=!1,l.showShop=!0,l.showAct=!1})},y=function(b){var c=b;c.scrollTop=l.scrollTop,a.$broadcast("intoShop",c)},z=j+"/user/goods/info",A=j+"/user/shop/name";a.$on("_recvObjChannel",function(b,d){if("shop"===d.type){var e={shopIDs:[]};c.post(o,e).success(function(b){l.fansid=b.addShopIDs;a.isFans=l.fansid.in_array(d.id)});var f={sid:d.id,sname:d.name,isFans:!a.isFans,fromChat:!0};l._intoShop(f)}else if("goods"===d.type){var g={gid:d.id};c({url:n,method:"GET",params:{limit:0,offset:0}}).success(function(b){for(l.favids=[],i=0;i<b.goods.length;i++)favids[i]=b.goods[i].id;a.isfaved=l.favids.in_array(d.id)}),c({url:z,method:"GET",params:{gid:d.id}}).success(function(b){0==b.err&&(g.sid=b.info.shop_id,c({url:A,method:"GET",params:{sid:b.info.shop_id}}).success(function(b){0==b.err&&(g.sname=b.shopName,g.isFans=!a.isfaved,l._intoShop(g))}).error())}).error()}else if("act"===d.type){var h={id:d.id};l.chatToAct(h)}}),a.$on("recv",function(a,b){g.cancel(u),v=!0}),a.$on("closeShop",function(a,b){if(document.title="粉店 -喵喵熊",void 0!=b.idx)l.allfavData[b.idx].ifshow=!b.isFans;else for(i=0;i<l.allfavData.length;i++)if(b.shop_id==l.allfavData[i].id){l.allfavData[i].ifshow=!b.isFans;break}l.shopsShow=!0,l.showShop=!1,e(function(){d.scrollTo(0,b.scrollTop)},100)}),a.$on("closeGoods",function(a,b){document.title="粉店 -喵喵熊",l.shopsShow=!0,l.showShop=!1,e(function(){d.scrollTo(0,l.scrollTop)},100)}),p(1);var B=200,C=1,D=0;a.$on("scroll",function(a,b){{var c=($(window).scrollTop(),b.docHeight);$(window).height()}D=b.totalHeight,D>=c-B&&0!=l.allfavData.length&&C!=l.listnums&&(p(C+1),C++)})}])});