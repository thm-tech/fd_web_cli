"use strict";define(["angular","app","directives/doimg","directives/lazyload","services/checkcookie"],function(a,b){b.controller("shopDelCtrl",["$scope","$rootScope","$http","$q","$timeout","$interval","$window","$sce","hascookie",function(a,b,c,d,e,f,g,h,i){var j=18,k=6,l=0,m=b.proxyUrl,n=b.chatProxyUrl,o=m+"/user/shop/info",p=m+"/user/shop/activity",q=m+"/user/goods",r=n+"/chat/shops/usernum",s=m+"/user/goods/info",t=m+"/user/goods/fit",u=m+"/user/favorite/diff",v=m+"/user/goods/concern",w=a.shop={},x={},y=a.goods={},z=0,A=!1;w.showShop=!1,a.$on("intoShop",function(a,b){J("recv"),console.log("intoShop"),x=b,w.name=x.sname,x.fromChat&&(w.showShop=!0,w.goods=[]),x.gid?(w.showShop=!1,w.showGoods=!w.showShop,A=!0,console.log("giddddd,"+x.gid),z=x.gid,w.showGoodsDel(z)):(w.showShop=!0,w.showGoods=!w.showShop,F(),document.title=w.name+"-喵喵熊")});var B=6048e5,C=function(){return Date.parse(new Date)},D=function(a){var b=a.replace(/-/g,"/");return Date.parse(new Date(b))},E=function(){c({url:o,method:"GET",params:{sid:x.sid}}).success(function(b){0==b.err&&(w.info=b.info,a.attention=w.info.isFans)}).error()},F=function(){E(),G(x.sid,0,j)};w.goods=[],w._goods=[],w.noMoreGoods=!1;var G=function(a,b,d){c({url:q,method:"GET",params:{sid:a,offset:b,count:d}}).success(function(a){if(0==a.err){a.goodsList.length<j&&(w.noMoreGoods=!0);for(var b=0,c=a.goodsList.length;c>b;b++)a.goodsList[b].newGoods=C()-D(a.goodsList[b].time)<B?!0:!1;w.goods=w.goods.concat(a.goodsList),w._goods=a.goodsList,w.goodsLoading=!w.noMoreGoods}}).error()};w.activities=[],w._actList=[];var H=function(){c({url:p,method:"GET",params:{sid:x.sid}}).success(function(a){if(0==a.err){for(var b,c=756,d=new RegExp("height:(.*?)px; width:(.*?)px",["g"]),e=0,f=a.actList.length;f>e;e++){for(var g=a.actList[e].content;b=d.exec(g);)if(b[2]>c){var i=c,j=b[1]*c/b[2];g=g.replace(b[0],"height:"+String(j)+"px; width:"+String(i)+"px")}a.actList[e].content=h.trustAsHtml(g),a.actList[e].bt=a.actList[e].bt.split(" ")[0],a.actList[e].et=a.actList[e].et.split(" ")[0]}w.activities=a.actList}}).error()};w.slides=[];w.imgInterval=5e3,w.noWrapSlides=!1;var I=function(){if(0!=w.info.picList&&0==w.slides.length)for(var b=0,c=w.info.picList.length;c>b;b++)w.slides.push({img:w.info.picList[b]});var d=w.info["long"];console.log("lng,"+d),console.log("shop address,"+w.info.lat+"/"+w.info["long"]),a.mapOptions={ngCenter:{lat:parseFloat(w.info.lat),lng:parseFloat(w.info["long"])},marker:new BMap.Marker(new BMap.Point(w.info["long"],w.info.lat)),ngZoom:18,toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,locatecity:!1,resizeEnable:!1}};a.setZoomMessage=function(b){a.zoomMessage="You just zoomed to "+b+"!"},a.openMarkerInfo=function(b,c){b.preventDefault(),b.stopPropagation(),a.currentMarker=c,a.currentMarkerLat=c.getPosition().lat,a.currentMarkerLng=c.getPosition().lng,a.shopMap.addOverlay(a.myInfoWindow),a.shopMap.openInfoWindow(a.myInfoWindow,c.getPosition())},a.setMarkerPosition=function(a,b,c){a.setPosition(new BMap.Point(c,b))},w.interest=function(){if(i.check("cm")){var b=m+"/user/shop/concern?sid="+x.sid;a.attention?(console.log("delete interest"),a.attention=!a.attention,c({url:b,method:"DELETE"}).success(function(a){0==a.err&&(w.info.isFans=!1,--w.info.fans)}).error()):(console.log("post interest"),a.attention=!a.attention,c({url:b,method:"POST"}).success(function(a){0==a.err&&(w.info.isFans=!0,++w.info.fans)}).error())}},w.intoChat=function(){i.check("cm")&&J("_enterShopChannel",x.sid)},w.curNav="goods",w.modNav=function(a){if(i.check("cm")){if(O=1,P=1,a==w.curNav)return;w.curNav=a,"activity"==a?H():I()}};var J=function(b,c){c?a.$emit(b,c):a.$emit(b)};w.pLetter=function(){i.check("cm")&&a.$emit("_chatToOwnerChannel",x.sid)},w.sendShop=function(){if(i.check("cm")){var b={type:"shop"};b.img=0!=w.info.picList.length?w.info.picList[0]:"http://img.immbear.com/0cd4d258e246ce247e59addcdc3f925c.png",b.id=x.sid,b.name=x.sname,a.$emit("_sendObjChannel",b)}},w.sendGoods=function(b,c,d){if(i.check("cm")){var e={type:"goods",id:b,name:c,img:d};a.$emit("_sendObjChannel",e)}},w.close=function(){if(i.check("cm"))if(void 0!=x.idx){var a={idx:x.idx,fansNum:w.info.fans,isFans:w.info.isFans,cmCount:w.info.customers,scrollTop:x.scrollTop};J("closeShop",a)}else{var a={shop_id:x.sid,fansNum:w.info.fans,isFans:w.info.isFans,cmCount:w.info.customers};J("closeShop",a)}},w.showGoodsDel=function(a){i.check("cm")&&(z=a,w.scrollTop=$(window).scrollTop(),console.log("scrollTop,"+w.scrollTop),w.showShop=!1,w.showGoods=!w.showShop,K(a),M(),N(a,0,k))},y.imgInterval=5e3,y.noWrapSlides=!1;var K=function(a){c({url:s,method:"GET",params:{gid:a}}).success(function(a){if(y.slides=[],0==a.err){if(y.info=a.info,x.sid=y.info.shop_id,document.title=y.info.desp+"-喵喵熊",0!=y.info.picList.length)for(var b=0,d=y.info.picList.length;d>b;b++)y.slides.push({img:y.info.picList[b]});y.info.brandName=y.info.brandName?y.info.brandName:"-",y.info.detail=y.info.detail?y.info.detail:"-",y.info.remark=y.info.remark?y.info.remark:"-",c({url:r,method:"GET",params:{shop_id:y.info.shop_id}}).success(function(a){y.customers=a.is_success?a.shop_dict[y.info.shop_id]:0}).error()}}).error()},L=[],M=function(){c({url:u,method:"POST",data:{goodsIDs:[]}}).success(function(b){if(0==b.err){L=b.addGoodsIDs;for(var c=0,d=L.length;d>c;c++){if(L[c]==z){y.isFav=!0,a.favorite=y.isFav;break}y.isFav=!1,a.favorite=y.isFav}}}).error()};y.customerFit=[],y._customerFit=[],y.heightArr=[],y.noCusFit=!1;var N=function(a,b,d){c({url:t,method:"GET",params:{gid:a,offset:b,count:d}}).success(function(a){a.picList;0==a.err&&(a.picList.length<k&&(y.cusFitLoading=!1),y._customerFit=a.picList,y.customerFit=y.customerFit.concat(a.picList),0==y.customerFit.length&&(y.noCusFit=!0))}).error()};y.collectGoods=function(){i.check("cm")&&(a.favorite?(a.favorite=!a.favorite,c({url:v+"?gid="+z,method:"DELETE"}).success(function(a){0==a.err&&(y.isFav=!1,--y.info.attention_count)}).error()):(a.favorite=!a.favorite,c({url:v+"?gid="+z,method:"POST"}).success(function(a){0==a.err&&(y.isFav=!0,++y.info.attention_count)}).error()))},y.pLetter=function(){i.check("cm")&&a.$emit("_chatToOwnerChannel",x.sid)},y.sendGoods=function(){if(i.check("cm")){var b={type:"goods",id:y.info.id,name:y.info.desp,img:y.info.picList[0]};a.$emit("_sendObjChannel",b)}},y.intoShop=function(){w.info?(console.log("not get shop,"+w.scrollTop),w.showShop=!0,w.showGoods=!w.showShop,document.title=x.sname+"-喵喵熊",e(function(){g.scrollTo(0,w.scrollTop)},100)):(console.log("get shop"),w.showShop=!0,w.showGoods=!w.showShop,F(),document.title=x.sname+"-喵喵熊")},y.showLarge=!1,y.largeSrc="",y.dealImg=function(a,b){i.check("cm")&&(console.log("deal image"),b==y.curImg?y.closeLarge():(y.noLast=b?!1:!0,y.noNext=b==y.customerFit.length-1?!0:!1,y.curImg=b,y.showLarge=!0,y.largeSrc=a+"@500w_500h_0e_1l"))},y.lastImg=function(){if(i.check("cm")){if(y.noLast)return!1;y.noNext=!1,y.largeSrc=y.customerFit[--y.curImg]+"@500w_500h_0e_1l",console.log("last image,"+y.curImg),0==y.curImg&&(console.log("no last"),y.noLast=!0)}},y.nextImg=function(){if(i.check("cm")){if(y.noNext)return!1;y.noLast=!1,y.largeSrc=y.customerFit[++y.curImg]+"@500w_500h_0e_1l",console.log("next image,"+y.curImg),y.curImg==y.customerFit.length-1&&(console.log("no next"),y.noNext=!0)}},y.closeLarge=function(){y.curImg=null,y.showLarge=!1},y.close=function(){i.check("cm")&&(A?J("closeGoods",{id:z,isFav:y.isFav}):(w.showShop=!0,w.showGoods=!w.showShop,document.title=x.sname+"-喵喵熊",e(function(){g.scrollTo(0,w.scrollTop)},100)))};var O=1,P=1;w.goodsLoading=!0,w.actLoading=!0;var Q=1;a.$on("scroll",function(a,b){if(w.showShop){if("goods"==w.curNav){if(b.docHeight-l<=b.totalHeight&&0!=w._goods.length){console.log("load shop goods"),w.goodsLoading=!0;var c=O*j;G(x.sid,c,j),O++}}else if("activity"==w.curNav&&b.docHeight-l<=b.totalHeight&&0!=w._actList.length){console.log("load shop act"),w.actLoading=!0;var c=5*P;H(c,5,!1),P++}}else if(b.docHeight-l<=b.totalHeight&&0!=y._customerFit.length){y.cusFitLoading=!0;var c=Q*k;N(z,c,k),Q++}})}])});